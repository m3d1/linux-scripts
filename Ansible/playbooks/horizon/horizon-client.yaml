
# Install Omnissa Horizon Client on Ubuntu 24.04 (amd64)
# Run: ansible-playbook -i inventory.yml install_horizon.yml
# Hosts group: agents

- name: Install Omnissa Horizon Client (Ubuntu 24.04)
  hosts: agents
  gather_facts: true
  become: true
  become_user: root

  vars:
    # --- Package source
    horizon_deb_url: "https://download3.omnissa.com/software/CART26FQ4_LIN64_DEBPKG_2512/Omnissa-Horizon-Client-2512-8.17.0-20187591429.x64.deb"
    horizon_deb_local: "/var/tmp/Omnissa-Horizon-Client-2512.deb"

    # --- libgtk requirement
    libgtk_pkg_name: "libgtk-3-0"
    libgtk_min_version: "3.14"

    # --- Common prerequisites
    prerequisite_packages:
      - "{{ libgtk_pkg_name }}"
      - libglib2.0-0
      - libx11-6
      - libxtst6
      - libxi6
      - libxrandr2
      - libxfixes3
      - libxrender1
      - libatk1.0-0
      - libc6
      - libstdc++6
      - libgcc-s1
      - libnss3
      - ca-certificates
      - desktop-file-utils   # for update-desktop-database

    # --- Old package names to purge (VMware/Omnissa/horizon)
    legacy_pkg_patterns:
      - '^vmware-horizon-client$'
      - '^vmware-view$'
      - '^omnissa-horizon-client$'
      - '^horizon-client$'

    # --- Desktop entries
    desktop_entry_path_system: "/usr/share/applications/omnissa-horizon-client.desktop"
    desktop_entry_name: "Omnissa Horizon Client.desktop"
    skel_desktop_dir: "/etc/skel/Desktop"

    # Fallback .desktop content (if vendor .desktop not found)
    desktop_entry_content_fallback: |
      [Desktop Entry]
      Type=Application
      Name=Omnissa Horizon Client
      Comment=Client VDI Omnissa Horizon
      Exec=/usr/bin/horizon-client
      Icon=horizon-client
      Terminal=false
      Categories=Network;RemoteAccess;
      X-GNOME-UsesNotifications=true

    # --- Horizon user preferences (one per line)
    horizon_ssl_verification_mode: '3'                     # 3 = Do not verify server identity certificate
    horizon_default_broker: 'https://myvd.aui.ma'
    horizon_auto_connect_broker: 'FALSE'
    horizon_all_monitors: 'FALSE'
    horizon_enable_h264: 'TRUE'                            
    horizon_non_interactive: 'FALSE'
    horizon_share_removable_storage: 'FALSE'
    horizon_enable_datasharing: 'FALSE'

  pre_tasks:
    - name: Verify running as root (effective UID)
      ansible.builtin.command: id -u
      register: uid_check
      changed_when: false
      failed_when: uid_check.stdout | int != 0

    - name: Validate distribution is Ubuntu amd64
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] == 'Ubuntu'
          - ansible_facts['architecture'] in ['x86_64', 'amd64']
        fail_msg: "this playbook work only with Ubuntu 24.04."

    - name: Update apt cache if older than 2h
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 7200

    # ---- libgtk check (robuste, évite les chaînes vides) -------------------
    - name: Check current libgtk-3-0 version (if installed)
      ansible.builtin.command: "dpkg-query -W -f='${Version}' {{ libgtk_pkg_name }}"
      register: libgtk_ver
      changed_when: false
      failed_when: false

    - name: Determine if libgtk is missing
      ansible.builtin.set_fact:
        libgtk_missing: "{{ libgtk_ver.rc != 0 }}"

    - name: Determine if libgtk version is below minimum
      ansible.builtin.set_fact:
        libgtk_too_low: "{{ (libgtk_ver.stdout | default('')) | length > 0 and (libgtk_ver.stdout is version(libgtk_min_version, '<')) }}"

    - name: Ensure libgtk-3-0 >= {{ libgtk_min_version }}
      ansible.builtin.apt:
        name: "{{ libgtk_pkg_name }}"
        state: present
      when: libgtk_missing or libgtk_too_low

    - name: Ensure prerequisite packages present
      ansible.builtin.apt:
        name: "{{ prerequisite_packages }}"
        state: present

  tasks:
    # ---- Download & install -------------------------------------------------
    - name: Check URL reachability before download (HEAD)
      ansible.builtin.uri:
        url: "{{ horizon_deb_url }}"
        method: HEAD
        status_code: 200
        return_content: false
        follow_redirects: safe
        validate_certs: true
      register: url_head
      changed_when: false

    - name: Download Omnissa Horizon Client .deb
      ansible.builtin.get_url:
        url: "{{ horizon_deb_url }}"
        dest: "{{ horizon_deb_local }}"
        mode: '0644'
        force: no
      register: deb_dl

    - name: Extract package name from .deb (control field)
      ansible.builtin.command: "dpkg-deb -f {{ horizon_deb_local }} Package"
      register: horizon_pkgname
      changed_when: false

    - name: List installed Horizon-like packages
      ansible.builtin.shell: |
        set -e
        dpkg -l | awk '/^ii/ {print $2}' | egrep -i '{{ legacy_pkg_patterns | join("|") }}' || true
      args:
        executable: /bin/bash
      register: legacy_installed
      changed_when: false

    - name: Purge old Horizon packages (if any)
      ansible.builtin.apt:
        name: "{{ legacy_installed.stdout_lines }}"
        state: absent
        purge: true
      when: legacy_installed.stdout_lines | length > 0

    - name: Purge package with same name as new .deb (safety)
      ansible.builtin.apt:
        name: "{{ horizon_pkgname.stdout }}"
        state: absent
        purge: true

    - name: Install Omnissa Horizon Client from .deb
      ansible.builtin.apt:
        deb: "{{ horizon_deb_local }}"
        state: present
      register: install_result

    - name: Attempt to fix missing dependencies if installation failed
      ansible.builtin.shell: |
        set -e
        apt-get -y -o Dpkg::Options::=--force-confold -f install
      when: install_result is failed
      register: fixdeps_result
      changed_when: "'Setting up' in (fixdeps_result.stdout + fixdeps_result.stderr)"

    - name: Re-try install after fixing dependencies (if needed)
      ansible.builtin.apt:
        deb: "{{ horizon_deb_local }}"
        state: present
      when: install_result is failed

    - name: Verify installation with dpkg -s
      ansible.builtin.command: "dpkg -s {{ horizon_pkgname.stdout }}"
      register: post_install_verify
      changed_when: false

    # ---- Discover launcher .desktop or binary ------------------------------
    - name: List files installed by the Horizon package
      ansible.builtin.command: "dpkg -L {{ horizon_pkgname.stdout }}"
      register: horizon_pkg_files
      changed_when: false

    - name: Locate vendor .desktop file shipped by the package (if any)
      ansible.builtin.set_fact:
        vendor_desktop: >-
          {{
            (horizon_pkg_files.stdout_lines
             | select('match', '^/usr/share/applications/.*\\.desktop$')
             | list | first) | default('')
          }}

    - name: Locate horizon-client binary
      ansible.builtin.shell: "command -v horizon-client || true"
      register: horizon_bin
      changed_when: false

    - name: Ensure we have either a vendor .desktop or horizon-client binary
      ansible.builtin.assert:
        that:
          - (vendor_desktop | length > 0) or (horizon_bin.stdout | length > 0)
        fail_msg: >-
          No launcher detected :  .desktop found, nor 'horizon-client' found.
          Please check your .deb file and try again.

    # ---- Install desktop entry (prefer vendor .desktop) ---------------------
    - name: Install system desktop entry from vendor .desktop
      ansible.builtin.copy:
        src: "{{ vendor_desktop }}"
        remote_src: true
        dest: "{{ desktop_entry_path_system }}"
        owner: root
        group: root
        mode: '0644'
      when: vendor_desktop | length > 0
      notify: Update desktop database

    - name: Generate minimal system desktop entry (fallback to horizon-client)
      ansible.builtin.copy:
        dest: "{{ desktop_entry_path_system }}"
        owner: root
        group: root
        mode: '0644'
        content: "{{ desktop_entry_content_fallback }}"
      when: vendor_desktop | length == 0
      notify: Update desktop database

    # ---- Seed shortcut for new users ---------------------------------------
    - name: Ensure /etc/skel/Desktop exists
      ansible.builtin.file:
        path: "{{ skel_desktop_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Seed shortcut for future users via /etc/skel
      ansible.builtin.copy:
        dest: "{{ skel_desktop_dir }}/{{ desktop_entry_name }}"
        src: "{{ desktop_entry_path_system }}"
        remote_src: true
        owner: root
        group: root
        mode: '0755'


  
  #Comment
    # ---- Seed preferences for new users (via /etc/skel) --------------------
    - name: Ensure /etc/skel/.omnissa exists
      ansible.builtin.file:
        path: /etc/skel/.omnissa
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Seed default horizon-preferences in /etc/skel
      ansible.builtin.copy:
        dest: /etc/skel/.omnissa/horizon-preferences
        owner: root
        group: root
        mode: '0644'
        content: |
          view.sslVerificationMode = '{{ horizon_ssl_verification_mode }}'
          view.defaultBroker = '{{ horizon_default_broker }}'
          view.autoConnectBroker = '{{ horizon_auto_connect_broker }}'
          view.allMonitors = '{{ horizon_all_monitors }}'
          view.enableH264 = '{{ horizon_enable_h264 }}'
          view.nonInteractive = '{{ horizon_non_interactive }}'
          view.shareRemovableStorage = '{{ horizon_share_removable_storage }}'
          view.enableDataSharing = '{{ horizon_enable_datasharing }}'

    # ---- Apply preferences to EXISTING users --------------------------------
    - name: Detect existing user home directories (UID >= 1000)
      ansible.builtin.shell: |
        awk -F: '$3>=1000 && $1!="nobody" {print $6}' /etc/passwd | sort -u
      register: user_homes
      changed_when: false

    - name: Stat each home to capture owner/group
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ user_homes.stdout_lines }}"
      register: homes_stat

    # - name: Ensure /home/lab08/.omnissa exists
    #   ansible.builtin.file:
    #     path: /home/lab08/.omnissa
    #     state: directory
    #     owner: ubuntu
    #     group: ubuntu
    #     mode: '0755'

    - name: Ensure /home/lab08/.omnissa/horizon-preferences exists
      ansible.builtin.file:
        path: /home/lab08/.omnissa/horizon-preferences
        state: touch
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Apply Horizon preferences (idempotent) for user ubuntu
      ansible.builtin.lineinfile:
        path: /home/lab08/.omnissa/horizon-preferences
        regexp: "^{{ item.key | regex_escape }}\\s*=.*$"
        line: "{{ item.key }} = '{{ item.val }}'"
        create: true
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        backrefs: false
      loop:
        - { key: 'view.sslVerificationMode',    val: "{{ horizon_ssl_verification_mode }}" }
        - { key: 'view.defaultBroker',         val: "{{ horizon_default_broker }}" }
        - { key: 'view.autoConnectBroker',     val: "{{ horizon_auto_connect_broker }}" }
        - { key: 'view.allMonitors',           val: "{{ horizon_all_monitors }}" }
        - { key: 'view.enableH264',            val: "{{ horizon_enable_h264 }}" }
        - { key: 'view.nonInteractive',        val: "{{ horizon_non_interactive }}" }
        - { key: 'view.shareRemovableStorage', val: "{{ horizon_share_removable_storage }}" }
        - { key: 'view.enableDataSharing',     val: "{{ horizon_enable_datasharing }}" }

    # - name: Ensure horizon-preferences file exists for each user
    #   ansible.builtin.file:
    #     path: "{{ item.stat.path }}/.omnissa/horizon-preferences"
    #     state: touch
    #     owner: "{{ item.stat.pw_name | default('root') }}"
    #     group: "{{ item.stat.gr_name | default('root') }}"
    #     mode: '0644'
    #   loop: "{{ homes_stat.results }}"
    #   when: item.stat.exists | default(false)

    # - name: Build preferences list (as dicts) to apply
    #   ansible.builtin.set_fact:
    #     horizon_prefs:
    #       - { key: 'view.sslVerificationMode',    val: "{{ horizon_ssl_verification_mode }}" }
    #       - { key: 'view.defaultBroker',         val: "{{ horizon_default_broker }}" }
    #       - { key: 'view.autoConnectBroker',     val: "{{ horizon_auto_connect_broker }}" }
    #       - { key: 'view.allMonitors',           val: "{{ horizon_all_monitors }}" }
    #       - { key: 'view.enableH264',            val: "{{ horizon_enable_h264 }}" }
    #       - { key: 'view.nonInteractive',        val: "{{ horizon_non_interactive }}" }
    #       - { key: 'view.shareRemovableStorage', val: "{{ horizon_share_removable_storage }}" }

    # - name: Apply Horizon preferences (idempotent) to each user
    #   ansible.builtin.lineinfile:
    #     path: "{{ item.0.stat.path }}/.omnissa/horizon-preferences"
    #     regexp: "^{{ item.1.key | regex_escape }}\\s*=.*$"
    #     line: "{{ item.1.key }} = '{{ item.1.val }}'"
    #     create: true
    #     owner: "{{ item.0.stat.pw_name | default('root') }}"
    #     group: "{{ item.0.stat.gr_name | default('root') }}"
    #     mode: '0644'
    #     backrefs: false
    #   loop: "{{ homes_stat.results | selectattr('stat.exists','defined') | selectattr('stat.exists') | list | subelements('ansible_facts.horizon_prefs', skip_missing=True) }}"
    #   vars:
    #     ansible_facts:
    #       horizon_prefs: "{{ horizon_prefs }}"

    
# --- Préférences pour l'utilisateur ubuntu -------------------------------

  handlers:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Update desktop database
      ansible.builtin.shell: "update-desktop-database || true"
      changed_when:

